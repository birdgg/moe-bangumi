# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build and Run Commands

This project uses [just](https://github.com/casey/just) as a command runner. Run `just --list` to see all available commands.

### Quick Start

```bash
just              # Start backend dev server (default)
just dev-all      # Start both backend and frontend dev servers
just --list       # Show all available commands
```

### Backend (Rust)

```bash
just build          # Build (debug)
just build-release  # Build (release)
just dev            # Run the server (defaults: port 3000, data path ./data)
just check          # Check compilation without building
just test           # Run tests
just watch          # Watch mode (requires cargo-watch)
```

### Frontend (Web)

```bash
just web-install    # Install dependencies
just web-dev        # Development server
just web-build      # Production build
just web-lint       # Lint
just web-gen-api    # Generate API client
just web-preview    # Preview production build
```

### Combined Commands

```bash
just dev-all        # Run both backend and frontend dev servers
just build-all      # Build both backend and frontend
```

## Configuration

Configuration is read from environment variables. Create a `.env` file in the project root:

```env
APP_ENV=dev       # Environment: dev or prod (default: dev)
PORT=3000         # Server port (default: 3000)
```

## Architecture

This is a Rust workspace for a Bangumi (anime) tracking and download management application, built with Axum and SQLite.

### Workspace Structure

- **crates/cli** - CLI entry point, reads config from .env and starts server
- **crates/server** - Core library with web server, API routes, and business logic
- **crates/bgmtv** - BGM.tv (Bangumi) API client for anime metadata
- **crates/qbittorrent** - qBittorrent Web API client
- **crates/downloader** - Downloader abstraction layer (supports qBittorrent, extensible)
- **crates/mikan** - Mikan (蜜柑计划) client for anime resource discovery
- **crates/parser** - Anime filename parser (extracts episode, season, subtitle group, resolution, etc.)
- **crates/pathgen** - Episode download path generator (Plex/Jellyfin compatible naming)
- **crates/rss** - RSS feed client for anime resources (Mikan, Nyaa support)
- **crates/tmdb** - TMDB API client for movie/TV metadata
- **web/** - Frontend application (React + Vite)

### Server Module Organization

```
server/src/
├── api/              # API route handlers (grouped by resource)
├── api.rs            # API module aggregation
├── models/           # Data models (Bangumi, RSS, Settings, etc.)
├── models.rs         # Models module aggregation
├── repositories/     # Database access layer
├── repositories.rs   # Repositories module aggregation
├── services/         # Business logic and external service integrations
├── services.rs       # Services module aggregation
├── config.rs         # Configuration struct
├── db.rs             # Database connection and migrations
├── lib.rs            # Library entry point
├── openapi.rs        # OpenAPI/Swagger documentation
├── seed.rs           # Database seeding utilities
└── state.rs          # AppState with shared resources (DB pool, clients)
```

### Key Patterns

- **Layered architecture**: API handlers → Services → Repositories → Database
- **State sharing**: SQLite connection pool and API clients passed via Axum router state
- **Async**: All database operations and handlers are async (Tokio runtime)
- **Error handling**: Handlers log errors with tracing and return appropriate HTTP status codes

## Frontend Architecture

The `web/` directory contains a React frontend application.

### Tech Stack

- **React 19** - UI framework
- **Vite** - Build tool and dev server
- **TailwindCSS 4** - Utility-first CSS
- **Tanstack Router** - File-based routing
- **shadcn/ui** - UI component library (base-ui based)
- **Tabler Icons** - Icon library
- **Bun** - Package manager and runtime

### Frontend Structure

```
web/src/
├── main.tsx              # App entry point
├── index.css             # Global styles and Tailwind config
├── routeTree.gen.ts      # Auto-generated route tree
├── lib/
│   ├── utils.ts          # Utility functions (cn helper)
│   └── api/              # API client and types generated by hey-api
├── components/
│   ├── ui/               # shadcn UI components
├── features/             # Feature-based modules
└── routes/
```

### Feature-based Architecture

Features are organized in `src/features/` with each feature containing:
- `page.tsx` - Main page component
- `components/` - Feature-specific UI components
- `index.ts` - Barrel export for all components
- `hooks/` - Feature-specific React hooks (queries, mutations)

Each feature's route is defined in `src/routes/` with a simple import of the page component.

### Design Aesthetic
Always design with cute bangumi aesthetic:
- Colors: Soft pastels (sakura pink, sky blue, mint, cream) with smooth gradients
- Shapes: Rounded corners, pill buttons, avoid sharp angles
- Shadows: Soft colored shadows, subtle glow on hover
- Decorations: Stars ✦, hearts ♡, sparkles ✨, floating elements
- Typography: Rounded, playful fonts with gentle spacing
- Effects: Frosted glass blur, bouncy micro-animations
- Anime touch: Character art accents, seasonal motifs, expressive icons

### Key Frontend Patterns

- **Design Style**: when design page or component, consider cute style first
- **File-based routing**: Routes defined in `src/routes/` directory
- **CSS Variables**: Theme colors defined in `index.css` using oklch
- **Dark mode**: Toggle via `.dark` class on document element
- **Component styling**: Uses `cn()` helper for conditional class merging

### TailwindCSS 4 Conventions
- **Respect theme colors**: Use CSS variable-based colors (`chart-1` to `chart-5`) instead of hardcoded colors
  - Use `text-chart-1`, `bg-chart-3/20`, `border-chart-1/30` instead of `text-pink-400`, `bg-purple-200/20`
  - Theme colors are defined in `index.css` and can be changed dynamically via `ThemeColorSelector`
  - Color mapping: `chart-1` (primary), `chart-2`, `chart-3` (secondary), `chart-4`, `chart-5` (accent)

## Database Migrations

Since the project is not yet released, database schema changes should be added directly to `migrations/001_init.sql` instead of creating new migration files. After modifying the init file, delete `data/moe.db` to recreate the database on next server start.

## Coding Conventions

### Rust Module Style

- **Do NOT use `mod.rs`** for module definitions. Use `module_name.rs` + `module_name/` directory instead of `module_name/mod.rs`.
- Example: Use `models.rs` + `models/bangumi.rs` instead of `models/mod.rs` + `models/bangumi.rs`